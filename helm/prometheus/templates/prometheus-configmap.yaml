apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ .Values.prometheus.scrapeInterval }}
      evaluation_interval: {{ .Values.prometheus.evaluationInterval }}
    
    scrape_configs:
      - job_name: "prometheus"
        static_configs:
          - targets: ["localhost:9090"]
      
      {{- if .Values.nodeExporter.enabled }}
      - job_name: "node"
        static_configs:
          - targets: ["node-exporter.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.nodeExporter.service.port }}"]
      {{- else if .Values.nodeExporter.autoDiscover }}
      # Auto-discover node-exporter using Kubernetes service discovery
      - job_name: "node"
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names: []  # Empty means all namespaces
        relabel_configs:
          # Keep only endpoints with node-exporter related labels
          - source_labels: [__meta_kubernetes_service_name]
            regex: (node-exporter|prometheus-node-exporter|node-exporter-prometheus-node-exporter)
            action: keep
          # Use the service port named 'metrics' or 'http-metrics' or port 9100
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            regex: (metrics|http-metrics|http)
            action: keep
          # Set instance label to node name if available
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node
          # Set namespace label
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          # Set pod label
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
      {{- end }}
      
      - job_name: "grafana"
        static_configs:
          - targets:
              - {{ printf "%s.%s.svc.cluster.local:3000" (include "prometheus.grafanaServiceName" .) .Release.Namespace | quote }}
    
    rule_files:
      - /etc/prometheus/rules/alert.rules.yml
      
    storage:
      tsdb:
        # Prometheus 3.x setting for accepting partially out-of-order ingestion
        out_of_order_time_window: 30m

    {{- if .Values.prometheus.enableOtlp }}
    # Native OTLP receiver (Prometheus â‰¥ 3.0)
    otlp:
      translation_strategy: UnderscoreEscapingWithSuffixes
      keep_identifying_resource_attributes: true
      promote_resource_attributes:
        - service.name
        - service.instance.id
        - service.namespace
        - service.version
        - k8s.cluster.name
        - k8s.namespace.name
        - k8s.pod.name
        - k8s.container.name
        - container.image.name
        - container.image.tag
        - cloud.region
        - cloud.availability_zone
    {{- end }}

    # Remote write is optional; disabled by default
    remote_write: []

    # Remote read is unused in TSDB-only mode
    remote_read: []
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
                - {{ printf "%s.%s.svc.cluster.local:9093" (include "prometheus.alertmanagerServiceName" .) .Release.Namespace | quote }}
