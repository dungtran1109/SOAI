apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-configmap
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      hostmetrics:
        collection_interval: 10s
        scrapers:
          cpu: {}
          memory: {}
          disk: {}
          filesystem: {}
          network: {}
          load: {}
{{- if .Values.otel.prometheus.enabled }}
      prometheus:
        config:
          scrape_configs:
            - job_name: 'otel-collector'
              scrape_interval: 15s
              static_configs:
                - targets: ['0.0.0.0:8888']
          {{- if .Values.otel.prometheus.scrapeConfigs.jobs.pod.enabled }}
            {{- include "otel-collector.configJobs" (list . "pod") | nindent 12 }}
          {{- end }}
          {{- if .Values.otel.prometheus.scrapeConfigs.jobs.service.enabled }}
            {{- include "otel-collector.configJobs" (list . "service") | nindent 12 }}
          {{- end }}
          {{- if .Values.otel.prometheus.scrapeConfigs.jobs.endpoint.enabled }}
            {{- include "otel-collector.configJobs" (list . "endpoints") | nindent 12 }}
          {{- end }}
{{- end }}
    exporters:
      debug:
        verbosity: normal
      prometheusremotewrite:
        endpoint: "http://prometheus:9090/api/v1/write"
        tls:
          insecure: true
{{- if .Values.otel.clickHouse.enabled }}
      clickhouse:
        endpoint: tcp://clickhouse:9000
        username: soai_user
        password: soai_password
        database: otel
        create_schema: true
        logs_table_name: otel_logs
        traces_table_name: otel_traces
        metrics_table_name: otel_metrics
        timeout: 5s
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s
        # TTL configuration - auto-delete old data to prevent unbounded growth
        ttl: 168h  # 7 days for logs (default table)
        logs:
          ttl: 168h  # 7 days
        traces:
          ttl: 336h  # 14 days
        metrics:
          ttl: 720h  # 30 days
{{- end }}
    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 1000
        spike_limit_mib: 200
      # Filter out noisy health check and probe logs
      filter/logs:
        logs:
          exclude:
            match_type: regexp
            bodies:
              - '.*"GET /health.*'
              - '.*"GET /api/v1/.*/health.*'
              - '.*readiness.*'
              - '.*liveness.*'
              - '.*healthcheck.*'
              - '.*GET /metrics.*'
      # Tail sampling for traces - keep error traces and sample others
      tail_sampling:
        decision_wait: 10s
        num_traces: 100
        expected_new_traces_per_sec: 10
        policies:
          - name: error-policy
            type: status_code
            status_code: {status_codes: [ERROR]}
          - name: probabilistic-policy
            type: probabilistic
            probabilistic: {sampling_percentage: 20}
      k8sattributes:
        auth_type: serviceAccount
        filter:
          namespace: "{{ .Release.Namespace }}"
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.deployment.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.cronjob.name
            - k8s.job.name
            - k8s.node.name
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.pod.start_time
            - container.image.name
            - container.image.tag
            - k8s.container.name
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: connection
      resource:
        attributes:
          - action: insert
            from_attribute: k8s.pod.uid
            key: service.instance.id
      batch:
        send_batch_size: 5000
        timeout: 10s
      # Smaller batch for logs to reduce memory pressure
      batch/logs:
        send_batch_size: 2000
        timeout: 5s
      transform:
        error_mode: ignore
        metric_statements:
          - context: datapoint
            statements:
              - set(attributes["k8s_cluster_name"], resource.attributes["k8s.cluster.name"])
              - set(attributes["namespace"], resource.attributes["k8s.namespace.name"])
              - set(attributes["container"], resource.attributes["k8s.container.name"])
              - set(attributes["pod"], resource.attributes["k8s.pod.name"])
      transform/logs:
        error_mode: ignore
        log_statements:
          - context: resource
            statements:
              - keep_keys(attributes, ["k8s.namespace.name", "k8s.container.name", "k8s.pod.name"])
          - context: log
            statements:
              - set(attributes["namespace"], resource.attributes["k8s.namespace.name"])
              - set(attributes["container"], resource.attributes["k8s.container.name"])
              - set(attributes["pod"], resource.attributes["k8s.pod.name"])
              - set(attributes["message"], body)
              - set(body, "")
              - delete_key(resource.attributes, "k8s.namespace.name")
              - delete_key(resource.attributes, "k8s.container.name")
              - delete_key(resource.attributes, "k8s.pod.name")
    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: 0.0.0.0
                    port: 8888
        logs:
          encoding: json
      pipelines:
        metrics/primary:
          receivers:
            - otlp
            - hostmetrics
            {{- if .Values.otel.prometheus.enabled }}
            - prometheus
            {{- end }}
          processors: [memory_limiter, k8sattributes, resource, transform, batch]
          exporters:
            - prometheusremotewrite
            - {{ include "otel-collector.exporter" . }}
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, tail_sampling, batch]
          exporters: [{{ include "otel-collector.exporter" . }}]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, filter/logs, k8sattributes, transform/logs, batch/logs]
          exporters: [{{ include "otel-collector.exporter" . }}]