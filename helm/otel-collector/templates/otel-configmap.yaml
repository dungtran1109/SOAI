apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-configmap
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      hostmetrics:
        collection_interval: 10s
        scrapers:
          cpu: {}
          memory: {}
          disk: {}
          filesystem: {}
          network: {}
          load: {}
{{- if .Values.otel.prometheus.enabled }}
      prometheus:
        config:
          scrape_configs:
            - job_name: 'otel-collector'
              scrape_interval: 15s
              static_configs:
                - targets: ['0.0.0.0:8888']
          {{- if .Values.otel.prometheus.scrapeConfigs.jobs.pod.enabled }}
            {{- include "otel-collector.configJobs" (list . "pod") | nindent 12 }}
          {{- end }}
          {{- if .Values.otel.prometheus.scrapeConfigs.jobs.service.enabled }}
            {{- include "otel-collector.configJobs" (list . "service") | nindent 12 }}
          {{- end }}
          {{- if .Values.otel.prometheus.scrapeConfigs.jobs.endpoint.enabled }}
            {{- include "otel-collector.configJobs" (list . "endpoints") | nindent 12 }}
          {{- end }}
{{- end }}
    exporters:
      debug:
        verbosity: normal
      prometheusremotewrite:
        endpoint: "http://prometheus:9090/api/v1/write"
        tls:
          insecure: true
{{- if .Values.otel.clickHouse.enabled }}
      clickhouse:
        endpoint: tcp://clickhouse:9000
        username: soai_user
        password: soai_password
        database: otel
        create_schema: true
        logs_table_name: otel_logs
        traces_table_name: otel_traces
        metrics_table_name: otel_metrics
        timeout: 5s
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s
{{- end }}
    processors:
      memory_limiter:
        check_interval: 1s
        limit_mib: 1000
        spike_limit_mib: 200
      k8sattributes:
        auth_type: serviceAccount
        filter:
          namespace: "{{ .Release.Namespace }}"
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.deployment.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.cronjob.name
            - k8s.job.name
            - k8s.node.name
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.pod.start_time
            - container.image.name
            - container.image.tag
            - k8s.container.name
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: connection
      resource:
        attributes:
          - action: insert
            from_attribute: k8s.pod.uid
            key: service.instance.id
      batch:
        send_batch_size: 10000
        timeout: 10s
      transform:
        error_mode: ignore
        metric_statements:
          - context: datapoint
            statements:
              - set(attributes["k8s_cluster_name"], resource.attributes["k8s.cluster.name"])
              - set(attributes["namespace"], resource.attributes["k8s.namespace.name"])
              - set(attributes["container"], resource.attributes["k8s.container.name"])
              - set(attributes["pod"], resource.attributes["k8s.pod.name"])
      transform/logs:
        error_mode: ignore
        log_statements:
          - context: resource
            statements:
              - keep_keys(attributes, ["k8s.namespace.name", "k8s.container.name", "k8s.pod.name"])
          - context: log
            statements:
              - set(attributes["namespace"], resource.attributes["k8s.namespace.name"])
              - set(attributes["container"], resource.attributes["k8s.container.name"])
              - set(attributes["pod"], resource.attributes["k8s.pod.name"])
              - set(attributes["message"], body)
              - set(body, "")
              - delete_key(resource.attributes, "k8s.namespace.name")
              - delete_key(resource.attributes, "k8s.container.name")
              - delete_key(resource.attributes, "k8s.pod.name")
    service:
      telemetry:
        metrics:
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: 0.0.0.0
                    port: 8888
        logs:
          encoding: json
      pipelines:
        metrics/primary:
          receivers:
            - otlp
            - hostmetrics
            {{- if .Values.otel.prometheus.enabled }}
            - prometheus
            {{- end }}
          processors: [memory_limiter, k8sattributes, resource, transform, batch]
          exporters:
            - prometheusremotewrite
            - {{ include "otel-collector.exporter" . }}
        traces:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [{{ include "otel-collector.exporter" . }}]
        logs:
          receivers: [otlp]
          processors: [k8sattributes, transform/logs, batch]
          exporters: [{{ include "otel-collector.exporter" . }}]